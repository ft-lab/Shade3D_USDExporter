# USD Exporter for Shade3D (ベータ)

PixarのUSD(Universal Scene Description)形式 ( https://graphics.pixar.com/usd/docs/index.html )のファイルをエクスポートするプラグインです。    
USDファイルとテクスチャをzipにまとめて1つにしたusdz形式を使用することで、AppleのiOS/iPadOSでARとして3Dモデルを使うことができるようになります。    

## USDについて

PixarのUSDについては、以下のページをご参照ください。    
https://graphics.pixar.com/usd/docs/index.html    

USDはオープンソースのフォーマットになります。    
https://github.com/PixarAnimationStudios/USD    

## USD Exporterの機能

以下の機能があります。    

* Shade3Dから、PixarのUSD形式/1つにまとめたUSDZ形式でエクスポート。

## 動作環境

* Windows 7/8/10以降のOS    
* Shade3D ver.15以降で、Standard/Professional版（Basic版では動作しません）  
  Shade3Dの64bit版のみで使用できます。32bit版のShade3Dには対応していません。   

※ 現状は、Windows版のみ対応しています。Mac版は後々ビルドします。    

## プラグインの配置、Shade3Dの起動方法

### プラグインと関連ファイルをダウンロード (Win)

関連ファイルは以下からダウンロードできます。    
https://github.com/ft-lab/Shade3D_USDExporter/releases    

USDを作成するために参照するDLLと関連ファイルと、Shade3Dプラグインの両方が必要になります。    

https://github.com/ft-lab/Shade3D_USDExporter/releases/download/usd_dlls/usd_dlls_1907.zip    
より、「usd_dlls_1907.zip」をダウンロードします。    
usd_dlls_1907.zipを解凍し、任意の場所に配置します。    
解凍すると、「usd_dlls」フォルダに「bin」と「lib」のフォルダが入っています。     
また、環境変数のPATHを通してShade3Dを起動するためのバッチファイル「run_shade3d_v17.bat」を同梱しています。    
これについては後述します。    

次に、Shade3Dプラグインをダウンロードします。    

https://github.com/ft-lab/Shade3D_USDExporter/releases    
より、最新の「USD Exporter ver.xxxx」のzipファイルをダウンロードして解凍します。    


### プラグインを配置し、Shade3Dを起動

Windowsの場合は、USDExporter64.dll をShade3Dのpluginsディレクトリに格納します。     

Shade3D実行時に「usd_dlls/bin」「usd_dlls/lib」フォルダへのPATH指定が必要です。    

以下のように、バッチファイル（*.bat）をテキストエディタで作ってShade3Dを起動します。    
> set USD_DLLS_PATH=E:\Data\Shade3D\USDExporter\usd_dlls    
> set PATH=%USD_DLLS_PATH%\bin;%USD_DLLS_PATH%\lib;%PATH%    
> cd C:\Program Files\Shade3D\Shade3D ver.17\bin    
> c:    
> shade.exe    

USD_DLLS_PATHは「usd_dlls」フォルダを展開したパスを指定します。    
set PATHで環境設定のパスを指定しています。    
この場合は、Shade3D ver.17を起動しています。    

「usd_dlls_1907.zip」を解凍すると、「run_shade3d_v17.bat」のファイルが同梱されています。    
上記と同じバッチファイルになります。    
「USD_DLLS_PATH」の指定を環境に合わせて書き換え、「C:\Program Files\Shade3D\Shade3D ver.17\bin」「c:」のドライブ指定を    
Shade3Dのバージョンに合わせて書き換えるようにしてください。    

メインメニューの「ファイル」-「エクスポート」-「USD」が表示されるのを確認します。     

## 使い方

出力したいシーンを作成します。    
この操作は、通常のShade3Dでのモデリング工程になります。   
モデリング時の注意点などは後述します。    
メインメニューの「ファイル」-「エクスポート」-「USD」を選択します。    
この項目が存在しない場合は、プラグインやUSDを作成するためのdllのパスが適切に指定されているか確認してください。    
<img src="./docs/images/usd_export_dlg.png" />    
「USD Export」ダイアログボックスでオプションを指定できます。    
エクスポートオプションについては後述します。    
OKボタンを押すと、ファイルダイアログボックスが表示されるため、usdcまたはusdaとして指定のフォルダに保存します。   

## エクスポートされるファイルについて

USDでは、テキスト形式の「usda」、バイナリ形式の「usdc」のどちらかの出力形態があります。    
USD Exporterプラグインでは、エクスポートオプションでどちらを出力するか選択できます。     
また、どちらの場合でもテクスチャイメージはjpgまたはpng形式で外部参照の形で別途出力されます。    

「usdzを出力」オプションがOnの場合は、「usda(もしくはusdc)」ファイルとテクスチャイメージがzipにまとめられて「usdz」の拡張子で出力されます。    
このusdzファイルをiOS/iPadOSのスマートフォンまたはタブレットに、iCloudやdropbox、メールなどを通して渡し、    
「AR Quick Look」（標準ビュワー）で開くことで、ARとして3Dモデルを見ることができます。    
usdzとして出力する場合は、ファイルサイズを小さくするためにusdcとして出力し、テクスチャは極力jpegファイルで出力することを推奨します。     

以下は、Shade3Dでの3Dモデルの表示です。     
<img src="./docs/images/usd_export_shade3d_01.png" />    
以下は、iOS13のAR Quick LookでのAR表示です。    
<img src="./docs/images/usd_export_shade3d_02.jpg" />    

エクスポートされるファイルの説明です。    

|ファイル拡張子|説明|    
|---|---|    
|usda|USDのシーンファイル (ASCII形式)|    
|usdc|USDのシーンファイル (バイナリ形式)|    
|jpg/png|参照しているテクスチャイメージ|    
|usdz|usda(usdc)とテクスチャイメージを1つのファイルにまとめてzipにしたもの。zip圧縮はされません。|    

## シーン階層と形状

シーンの階層構造は極力そのままUSDの構造に出力するようにしています。    
複数形状を配置することもできます。    
ただし、形状名/マテリアル（マスターサーフェス）名として全角文字を使えないため、
その場合はエクスポート時に自動的にASCII文字列に置き換えられます。    

自由曲面や回転体/掃引体などは、すべてポリゴンメッシュに変換されてエクスポートされるため、そのままでも問題ありません。    
レンダリングブーリアンには対応していないため（穴あきなど）、その場合はブール演算などを使用してポリゴンメッシュにするようにしてください。    

iOS/iPadOSでリアルタイムでAR表示する目的の場合は、極力面数やマテリアル/テクスチャ数を抑えるように最適化する必要があります。    

## 表面材質（マテリアル）の表現

USDでは「PBRマテリアル」として、diffuse(albedo)/normal/roughness/metallic/emissive/opacity/occlusionを値として、またはテクスチャとして割り当てることができます。     
USD Exporter for Shade3Dでは、表面材質ウィンドウを単純な入れ物として扱っており、    
レンダリング結果とUSD出力時のマテリアルでは表現が異なります（あえて一致させていません）。    
これについては、将来的に「ベイク」として合わせていくモードを用意する予定です。    

### 基本設定/効果設定で参照するもの

<img src="./docs/images/usd_export_material_01.png" />    

|Shade3Dのパラメータ|USDでのパラメータ|使用要素|テクスチャ|意味|
|---|---|---|---|---|
|拡散反射 (値と色)|diffuseColor|RGB|持てる|色(RGB)情報|
|反射 (値)|metallic|グレイスケール|持てる|反射（映り込み）の強さ|
|透明 (値)|1.0 - opacity|グレイスケール|持てる|不透明度(opacity)の逆|
|屈折 (値)|ior|値のみ|-|屈折率|
|荒さ (値)|roughness|グレイスケール|持てる|ざらつきの強さ|
|発光 (値と色)|emissive|RGB|持てる|発光の強さ|

これらの指定は、PBRマテリアルとしての表現となる点に注意してください。    
たとえば、鏡のような鏡面反射を行う場合、拡散反射をRGB(1.0, 1.0, 1.0)、反射を1.0、荒さを0.0と指定します。     
Shade3Dのレンダリングに合わせて拡散反射をRGB(0.0, 0.0, 0.0)とすると、USDで出力した際は黒光りの表現になります。    

### マッピングで参照するもの

マッピングはすべてUVマッピング（投影を「ラップ」にする）で行います。     
マッピングできるレイヤは、「イメージ/拡散反射」「イメージ/法線」「イメージ/反射」「イメージ/荒さ」「イメージ/発光」「イメージ/透明度」のいずれかになります。    
<img src="./docs/images/usd_export_material_02.png" />    
それぞれの要素は1層分だけ指定できます（マルチレイヤのベイクにはまだ対応していません）。    
このとき、「適用率」「色反転」が反映されます。    
「イメージ」タブの「UV」（ただし2層まで）、「タイリング」の「リピート/なし」、「反復」が反映されます。    

また、Occlusionについては、マッピングで「Occlusion(USD)」というのが選択できるため、それで割り当てます。     
<img src="./docs/images/usd_export_material_03.png" />    
パラメータは「その他」で指定します。    
Occlusionで「適用率」値が反映されます。    

### マッピングでのチャンネル合成について

マッピングでのチャンネル合成は、「アルファ乗算済み」でRGBが採用されます。    
「イメージ/拡散反射」時に「アルファ透明」を指定した場合は、RGBAテクスチャのAlpha要素が不透明度(Opacity)として採用されます。    
荒さ(roughness)や反射(metallic)、Occlusion、透明度 (1.0 - opacity)では、グレイスケールを指定することになり、     
チャンネル合成で「グレイスケール (R)」「グレイスケール (G)」「グレイスケール (B)」「グレイスケール (A)」をそれぞれ割り当てることができます。    

### iOS/iPadOSでのマテリアルの制限

iOS12とiOS13(iPadOS13)で実装が異なるため、表現も差異があります。    

* iOS12/13でのusdzの表示は、UV層は1層のみ認識されます。
* iOS12では「反復」の値 (UsdTransform2dを使用) は反映できません。
* iOS12では、Shade3Dでの「チャンネル合成」での「グレイスケール (R)」は反映されますが、G/B/Aの指定は反映されません（常にRだけ見ています）。    
* iOS12/iOS13共に、opacityを0にして完全透明にしても、わずかに色が付いています。    
また、opacity 1.0以外の指定がある場合は半透明面ごとのZソートが行われますがcutoutは行われないため、正常には表現できない箇所があります。    

## アニメーション

USDでのアニメーションは、    
ボーン＋スキンを使用したアニメーション(skeletal animation)と、    
形状単体に割り当てるアニメーション(transform animation)の2つが存在します。    
ともにキーフレームを与えることで形状を動かします。    
なお、USDでは1タイムラインを保持します（複数タイムラインを持つ構造はありません）。    

### ボーン＋スキンを使用したアニメーション(skeletal animation)

Shade3Dでの「ボーン」と「スキン」を使用したアニメーションを使用します。   
このとき、「ボーン」の変換行列は常に「回転 0」「せん断 0」「スケール 1」である必要があります。    
<img src="./docs/images/usd_export_bone_01.png" />    
「自動で軸合わせ」もOffにします。    

また、ボーンは必ず1つのボーン（ルートボーン）から親子階層になるようにします。    
このとき、ボーン内にポリゴンメッシュやパートなどの形状を持たせることはできません。    
ボーン構造とポリゴンメッシュは完全に分離した配置にします（スキンで関連付けすることになります）。    
シーンに複数のルートボーンを配置できます。    
なお、ルートボーンは、ルートパートの直下もしくは単位行列のパート内に配置するようにしてください。    

スキンは、「頂点ブレンド」で割り当てるようにします。    

ボーン＋スキンでバインドするポリゴンメッシュは、ルートパートの直下もしくは単位行列のパート内に配置するようにしてください。    

### 形状単体に割り当てるアニメーション(transform animation)

Shade3Dでは形状単体のアニメーションを行う構造はないため、
これは「ボールジョイント」に形状を入れたときのボールジョイントとしてのモーションで対応します。     
ボールジョイントの「移動」「回転」のキーフレーム割り当てがUSDに反映されます。    
<img src="./docs/images/usd_export_bone_02.png" />    
このとき、ボールジョイントは階層化しないようにしてください（現状の仕様です）。    
単一形状ごとに移動と回転のキーフレームを割り当てることになります。    

### USD出力でのキーフレームによるアニメーションの挙動

USD出力時は、キーフレーム間は線形補間されます。    
そのため、Shade3Dで割り当てた動きよりも直線的になってしまいます。    
USD Export時のオプションで「アニメーション」-「出力」を「ステップ指定」とすることで、     
Shade3Dのキーフレームを指定のステップ数で分割して出力します。    
<img src="./docs/images/usd_export_dlg_02.png" />    
キーフレーム間隔を細かくすることで、Shade3Dでのアニメーションの動きに忠実になります。    

## エクスポートオプション

USD Export時のオプションの説明です。    
<img src="./docs/images/usd_export_dlg.png" />    

### ファイル出力

「Appleのusdz互換」をOnにすると、出力形式を「usdc」、「usdzを出力」をOnとします。    
「出力形式」は「usda(ASCII)」か「usdc(バイナリ)」のいずれかを指定できます。    
iOS12の場合は「usda(ASCII)」を指定してusdzを出力しても、ARで見る際に認識されません(usdcを採用する必要があります)。     
iOS13の場合は、「usda(ASCII)」「usdc(バイナリ)」のどちらでもusdzに入れてARすることができるようになっています。    

「usdzを出力」をOnにすると、USDファイル(usda/usdc)とテクスチャファイルをまとめたusdzファイルを出力します。    

### 出力オプション
「Subdivision」はサブディビジョンを保持したまま出力するかどうかの指定です。    
これはまだ未実装部分のため、正しく動作しません。    

「ボーンとスキンを出力」は、アニメーションのためのボーンとスキン情報を出力する指定です。    
「頂点カラーを出力」は、ポリゴンメッシュの頂点カラー情報を出力します。まだ正しく動作しません。      

### テクスチャ

「テクスチャ」で出力するテクスチャイメージの種類を選択します。    
「イメージ名から拡張子を参照」でブラウザ上のマスターイメージ名に拡張子が指定されている場合、それを優先して採用します。    
png/jpeg以外はpngに置き換えられます。    
「pngに置き換え」でテクスチャを強制的にpngとして出力します。    
「jpegに置き換え」でテクスチャを強制的にjpegとして出力します。    
ただし、アルファ要素を持つテクスチャの場合でテクスチャがRGBA要素を持つ場合は、jpegの指定をしてもpngになります。    

「最大テクスチャサイズ」は、テクスチャサイズが一定サイズよりも大きくならないようにします。    
指定なし/256/512/1024/2048/4096を指定できます。    
「R/G/B/Aをグレイスケールに分けて出力」は、
roughness/metallic/occlusion/opacity指定時に1枚のグレイスケール画像として出力する指定です。     
「複数テクスチャをベイク」はまだ選択できません（未実装）。    

### アニメーション

「出力」で「なし」「キーフレームのみ」「ステップ指定」を選択できます。    
これは、キーフレームを出力するか（アニメーションさせるか）、
モーションウィンドウのキーフレームのみ出力するか、
一定間隔のステップ数でキーフレームを出力するか、の指定になります。    

## サンプルファイル

以下のページに、Shade3Dのshdファイルと    
エクスポートした usda + テクスチャファイルをzipにしたもの、    
usdzファイル、を置いています。     

https://ft-lab.github.io/usd.html


## 対応している機能

* USDのバイナリ(拡張子 usdc)またはテキスト(拡張子 usda)とテクスチャの出力
* zipにまとめたusdz形式の出力
* iOS12/iOS13のAR表示への対応 (iOS13を推奨)
* ポリゴンメッシュとして形状出力
* マテリアルはPBR (diffuse/roughness/metallic/normal/emissive/occlusion/opacity) として出力
* ボーン＋スキンを使用したアニメーション出力対応
* ボールジョイント内に形状を入れた場合、位置と回転をアニメーションのキーフレームとして出力

## doubleSided対応について

doubleSidedとは、リアルタイムでMeshを表示する場合に裏面を表示するかしないか、の指定です。    
USDでは、形状(Mesh)に対してdoubleSidedの指定が存在します。    
USD Exporter for Shade3Dでは、    
マスターサーフェス名として「xxxx_doublesided」のように、「doublesided」が含まれる場合（大文字の場合でも小文字として判断）にdoubleSidedが指定されたと判断します。    
なお、iOS12/iOS13ではdoubleSidedの指定は無効化され、常に「裏面は表示しない (doubleSided=false)」となるようです。    

## 制限事項

USDエクスポート時の制限事項です。    
USDの仕様によるものもあるため、それらは後述します。     

* 形状名やマテリアル名は、英数字と「_」に変換されます。    
全角文字を使用している場合は、名前がmeshなどに置き換わります。    
* 複数の形状名やマテリアル名が同一の場合、「_1」のような連番が割り振られます。
* 自由曲面や回転体/掃引体などは、すべてポリゴンメッシュに変換されます。    
* ポリゴンメッシュの多角形面は、三角形または四角形に分解されて出力されます。    
* ポリゴンメッシュのサブディビジョン出力には対応していません。    
アニメーション情報を持たない場合は、サブディビジョンを使用したポリゴンメッシュは再分割されます。    
アニメーション情報を持つ場合は、サブディビジョンを使用したポリゴンメッシュは正しく動作しません。    
* ポリゴンメッシュのUV層は最大2層まで出力されます。    
ただし、iOS12/iOS13ではUV層は1層しか認識されません。    
* 出力USD名が全角の場合、「output_日付_時間」の名前に変換されます。

## 制限事項 (USDの仕様)

以下は、USDの仕様になります。    
ここでの「Mesh」はShade3Dでの「ポリゴンメッシュ」と同等のものを指します。    

* 形状名やマテリアル名は、英数字とアンダーバーのみ使用できます。    
全角含むUTF-8には対応していません。    
また、名前の先頭は数字を指定できません。'a'-'z'、'A'-'Z'、アンダーバーを使用します。    
* USDの構造上、形状名やマテリアル名はパス形式で保持されます。    
区切り文字は「/」を使います。    
このとき、同一パス名を持つことはできません。    
* 出力するUSDファイル名は、全角文字を使用できません。
* MeshのUV層は最大2層まで持つことができます。    
* Meshの面は多角形を保持できますが、USDを表示するビュワー環境によっては凹面は正しく表現できない場合があるようです。    
複雑な面の場合は、三角形または四角形に分割したほうがいいかもしれません。    
* ボーン＋スキンを使用した場合、SkelRootというノードに情報を押し込みます。    
このときシーンのツリー構造からボーン構造を配列に変換して格納する必要があり、オリジナルのツリー構造は保持されなくなります。    
* テクスチャイメージは、pngまたはjpgを指定できます。アニメーションするイメージには対応していません。    

## 未調査

まだUSDの仕様として未調査の箇所です。

* Meshの頂点ごとに頂点カラーを持てるか。
* MorphTarget(BlendShapes)を表現できるか。

## ライセンス  

This software is released under the MIT License, see [LICENSE](./LICENSE).  

USDについては、Modified Apache 2.0 License になっています。    
https://github.com/PixarAnimationStudios/USD/blob/master/LICENSE.txt    
USDについては、この内容に従います。     

## 更新履歴

[2019/10/12] ver.0.0.1.0   

* 初回版 (ベータ)

